// L'ancienne version a été remplacée pour permettre la traduction dynamique FR/EN

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-lang="title">Mon itinéraire - Easy Trip</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>/* ...styles inchangés... */</style>
</head>
<body>
  <div class="header">
    <h1>Easy Trip</h1>
    <div>
      <span class="user-info" id="userInfo">Bienvenue !</span>
      <select id="langSelect">
        <option value="fr">🇫🇷 FR</option>
        <option value="en">🇬🇧 ENG</option>
      </select>
    </div>
  </div>

  <div class="content">
    <div id="guide">
      <p><strong data-lang="welcome">Bienvenue !</strong><br>
      <span data-lang="howto">Voici comment utiliser Easy Trip :</span></p>
      <ul>
        <li data-lang="step1">Entrez une activité (ex : visite musée)</li>
        <li data-lang="step2">Choisissez la date et l’heure de départ</li>
        <li data-lang="step3">Indiquez le lieu</li>
        <li data-lang="step4">Cliquez sur “Ajouter” pour générer votre itinéraire</li>
      </ul>
      <p data-lang="modify">Vous pouvez aussi modifier ou supprimer un événement.</p>
    </div>

    <form id="eventForm">
      <input type="date" id="eventDate" required>
      <input type="text" id="event" placeholder="Activité" required data-lang-placeholder="activity">
      <select id="startTime"></select>
      <input type="text" id="location" placeholder="Lieu" required data-lang-placeholder="place">
      <select id="transport">
        <option value="Voiture" data-lang="car">Voiture</option>
        <option value="Bus" data-lang="bus">Bus</option>
        <option value="Train" data-lang="train">Train</option>
      </select>
      <button type="submit" id="submitBtn" data-lang="add">Ajouter</button>
    </form>

    <ul id="eventList"></ul>
    <div id="map" style="height: 400px; margin-top: 2rem;"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const TRANSLATIONS = {
      fr: {
        title: "Mon itinéraire - Easy Trip",
        welcome: "Bienvenue !",
        howto: "Voici comment utiliser Easy Trip :",
        step1: "Entrez une activité (ex : visite musée)",
        step2: "Choisissez la date et l’heure de départ",
        step3: "Indiquez le lieu",
        step4: "Cliquez sur “Ajouter” pour générer votre itinéraire",
        modify: "Vous pouvez aussi modifier ou supprimer un événement.",
        add: "Ajouter",
        update: "Mettre à jour",
        activity: "Activité",
        place: "Lieu",
        car: "Voiture",
        bus: "Bus",
        train: "Train"
      },
      en: {
        title: "My Itinerary - Easy Trip",
        welcome: "Welcome!",
        howto: "Here's how to use Easy Trip:",
        step1: "Enter an activity (e.g., museum visit)",
        step2: "Choose the date and departure time",
        step3: "Indicate the location",
        step4: "Click on 'Add' to generate your itinerary",
        modify: "You can also modify or delete an event.",
        add: "Add",
        update: "Update",
        activity: "Activity",
        place: "Place",
        car: "Car",
        bus: "Bus",
        train: "Train"
      }
    };

    const utilisateur = JSON.parse(localStorage.getItem('utilisateur'));
    const userInfoDiv = document.getElementById('userInfo');
    const STORAGE_KEY = `evenements_${utilisateur?.nom}_${utilisateur?.prenom}`;
    const LANG_KEY = 'easytrip_lang';
    let langue = localStorage.getItem(LANG_KEY) || 'fr';
    let editingLi = null;

    function translatePage() {
      const dict = TRANSLATIONS[langue];
      document.title = dict.title;
      document.querySelectorAll('[data-lang]').forEach(el => {
        el.textContent = dict[el.dataset.lang];
      });
      document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
        el.placeholder = dict[el.dataset.langPlaceholder];
      });
      document.getElementById('submitBtn').textContent = editingLi ? dict.update : dict.add;
      document.querySelectorAll('#transport option').forEach(opt => {
        if (dict[opt.value]) opt.textContent = dict[opt.value];
      });
    }

    if (utilisateur) {
      const nomAffiche = utilisateur.nom === 'Invité' ? 'Invité' : `${utilisateur.prenom} ${utilisateur.nom}`;
      userInfoDiv.textContent = `Bienvenue, ${nomAffiche}`;
    } else {
      window.location.href = 'index.html';
    }

    const langSelect = document.getElementById("langSelect");
    langSelect.value = langue;
    langSelect.addEventListener("change", () => {
      langue = langSelect.value;
      localStorage.setItem(LANG_KEY, langue);
      translatePage();
    });

    const selectHeure = document.getElementById("startTime");
    for (let h = 0; h < 24; h++) {
      ["00", "30"].forEach(min => {
        const time = `${String(h).padStart(2, '0')}:${min}`;
        const option = document.createElement("option");
        option.value = time;
        option.textContent = time;
        selectHeure.appendChild(option);
      });
    }

    const form = document.getElementById("eventForm");
    const eventList = document.getElementById("eventList");
    const submitBtn = document.getElementById("submitBtn");

    function sauvegarderEvenements() {
      const items = [];
      eventList.querySelectorAll('li').forEach(li => {
        items.push(li.querySelector('span').textContent);
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    function chargerEvenements() {
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      data.forEach(txt => ajouterEvenement(txt));
    }

    function ajouterEvenement(texte) {
      const li = document.createElement("li");
      li.innerHTML = `<span>${texte}</span>
        <div>
          <button class="action-btn edit-btn">✏️</button>
          <button class="action-btn delete-btn">🗑️</button>
        </div>`;

      li.querySelector(".delete-btn").addEventListener("click", () => {
        li.remove();
        sauvegarderEvenements();
      });

      li.querySelector(".edit-btn").addEventListener("click", () => {
        const parts = li.querySelector('span').textContent.split(' - ');
        if (parts.length < 2) return;
        const date = parts[0];
        const rest = parts[1];
        const time = rest.substring(0, 5);
        const reste = rest.substring(6);

        document.getElementById("eventDate").value = date;
        document.getElementById("startTime").value = time;

        const [activity, restLieu] = reste.split(" à ");
        const [lieu, transport] = restLieu.split(" (");
        const cleanedTransport = transport.replace(")", "").trim();

        document.getElementById("event").value = activity.trim();
        document.getElementById("location").value = lieu.trim();
        document.getElementById("transport").value = cleanedTransport;

        editingLi = li;
        submitBtn.textContent = TRANSLATIONS[langue].update;
      });

      eventList.appendChild(li);
    }

    form.addEventListener("submit", function(e) {
      e.preventDefault();

      const date = document.getElementById("eventDate").value;
      const eventName = document.getElementById("event").value;
      const time = document.getElementById("startTime").value;
      const location = document.getElementById("location").value;
      const transport = document.getElementById("transport").value;

      const texte = `${date} - ${time} ${eventName} à ${location} (${transport})`;

      if (editingLi) {
        editingLi.querySelector('span').textContent = texte;
        editingLi = null;
        submitBtn.textContent = TRANSLATIONS[langue].add;
      } else {
        ajouterEvenement(texte);
      }

      sauvegarderEvenements();
      form.reset();
    });

    translatePage();
    chargerEvenements();
  </script>
</body>
</html>
